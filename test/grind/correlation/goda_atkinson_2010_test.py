#!/usr/bin/env python

import numpy as np

from openquake.hazardlib.imt import PGA, PGV, SA

import os.path
import sys

homedir = os.path.dirname(os.path.abspath(__file__))  # where is this script?
shakedir = os.path.abspath(os.path.join(homedir, '..', '..','..'))
sys.path.insert(0, shakedir)

import shakelib.grind.correlation.goda_atkinson_2010 as ga10


def test_goda_atkinson_2010():
    d = np.linspace(0, 10, 101)
    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, PGA())
    cor_target = np.array(
      [ 0.        ,  0.39235049,  0.43205433,  0.45704225,  0.47560355,
        0.490493  ,  0.50298594,  0.51378292,  0.52331214,  0.53185541,
        0.5396085 ,  0.54671319,  0.5532756 ,  0.55937735,  0.56508259,
        0.57044268,  0.57549947,  0.58028746,  0.5848355 ,  0.58916792,
        0.59330547,  0.59726599,  0.60106493,  0.60471575,  0.60823028,
        0.61161894,  0.61489101,  0.61805471,  0.62111745,  0.62408587,
        0.62696595,  0.62976314,  0.63248236,  0.63512811,  0.6377045 ,
        0.64021531,  0.64266398,  0.64505373,  0.64738748,  0.64966797,
        0.65189773,  0.6540791 ,  0.65621427,  0.65830527,  0.66035401,
        0.66236228,  0.66433173,  0.66626394,  0.66816036,  0.6700224 ,
        0.67185134,  0.67364841,  0.67541479,  0.67715155,  0.67885975,
        0.68054036,  0.68219431,  0.6838225 ,  0.68542575,  0.68700487,
        0.68856062,  0.69009373,  0.69160488,  0.69309473,  0.69456391,
        0.69601302,  0.69744265,  0.69885332,  0.70024558,  0.70161993,
        0.70297685,  0.7043168 ,  0.70564023,  0.70694757,  0.70823922,
        0.70951559,  0.71077704,  0.71202396,  0.71325668,  0.71447555,
        0.71568089,  0.71687303,  0.71805226,  0.71921887,  0.72037316,
        0.72151539,  0.72264583,  0.72376474,  0.72487235,  0.72596892,
        0.72705467,  0.72812983,  0.72919461,  0.73024923,  0.73129388,
        0.73232877,  0.73335409,  0.73437003,  0.73537675,  0.73637445,
        0.73736329])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, PGV())
    cor_target = np.array(
      [ 0.        ,  0.3575817 ,  0.39874653,  0.42491472,  0.44447585,
        0.4602403 ,  0.47351603,  0.48502441,  0.4952078 ,  0.50435814,
        0.51267872,  0.52031708,  0.52738388,  0.53396433,  0.54012554,
        0.54592134,  0.55139559,  0.55658456,  0.56151855,  0.56622319,
        0.57072035,  0.57502884,  0.57916497,  0.58314296,  0.58697532,
        0.5906731 ,  0.59424609,  0.59770305,  0.6010518 ,  0.60429941,
        0.60745223,  0.61051605,  0.6134961 ,  0.61639717,  0.61922365,
        0.62197954,  0.62466854,  0.62729404,  0.62985921,  0.63236693,
        0.63481993,  0.63722069,  0.63957157,  0.64187473,  0.64413223,
        0.64634596,  0.6485177 ,  0.65064914,  0.65274185,  0.65479732,
        0.65681693,  0.65880202,  0.66075382,  0.66267351,  0.66456221,
        0.66642097,  0.66825079,  0.67005263,  0.67182739,  0.67357593,
        0.67529906,  0.67699757,  0.6786722 ,  0.68032367,  0.68195264,
        0.68355976,  0.68514567,  0.68671094,  0.68825614,  0.68978183,
        0.69128852,  0.69277671,  0.69424688,  0.6956995 ,  0.697135  ,
        0.69855383,  0.69995637,  0.70134304,  0.70271421,  0.70407025,
        0.70541151,  0.70673833,  0.70805105,  0.70934997,  0.71063541,
        0.71190767,  0.71316703,  0.71441376,  0.71564814,  0.71687042,
        0.71808086,  0.7192797 ,  0.72046717,  0.72164351,  0.72280893,
        0.72396365,  0.72510787,  0.72624181,  0.72736565,  0.72847959,
        0.72958381])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(0.3))
    cor_target = np.array(
      [ 0.        ,  0.50305951,  0.5415847 ,  0.56538633,  0.58286091,
        0.59675844,  0.60833979,  0.61829248,  0.62703425,  0.63483861,
        0.64189473,  0.6483391 ,  0.65427353,  0.65977604,  0.6649078 ,
        0.66971766,  0.67424532,  0.67852342,  0.68257921,  0.68643562,
        0.69011218,  0.69362563,  0.69699045,  0.70021924,  0.70332305,
        0.70631162,  0.70919357,  0.71197657,  0.71466749,  0.71727249,
        0.71979714,  0.72224644,  0.72462498,  0.7269369 ,  0.72918599,
        0.73137573,  0.73350931,  0.73558966,  0.73761949,  0.73960131,
        0.74153743,  0.74343001,  0.74528104,  0.7470924 ,  0.74886581,
        0.75060292,  0.75230523,  0.75397419,  0.75561112,  0.75721728,
        0.75879388,  0.76034201,  0.76186273,  0.76335705,  0.7648259 ,
        0.76627017,  0.76769071,  0.76908832,  0.77046376,  0.77181775,
        0.77315099,  0.77446412,  0.77575778,  0.77703255,  0.778289  ,
        0.77952767,  0.78074909,  0.78195374,  0.7831421 ,  0.78431463,
        0.78547176,  0.78661391,  0.78774147,  0.78885483,  0.78995437,
        0.79104042,  0.79211334,  0.79317345,  0.79422107,  0.7952565 ,
        0.79628003,  0.79729195,  0.79829253,  0.79928202,  0.80026069,
        0.80122878,  0.80218652,  0.80313415,  0.80407187,  0.80499992,
        0.80591848,  0.80682778,  0.80772798,  0.80861929,  0.80950189,
        0.81037595,  0.81124164,  0.81209913,  0.81294858,  0.81379014,
        0.81462397])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(1.0))
    cor_target = np.array(
      [ 0.        ,  0.34369983,  0.38462439,  0.4107154 ,  0.4302548 ,
        0.44602318,  0.45931659,  0.47085065,  0.48106461,  0.49024857,
        0.4986047 ,  0.50627981,  0.51338405,  0.52000232,  0.52620149,
        0.53203522,  0.53754726,  0.54277378,  0.54774504,  0.55248663,
        0.55702037,  0.56136506,  0.56553699,  0.56955039,  0.57341775,
        0.57715013,  0.58075732,  0.58424807,  0.58763023,  0.59091084,
        0.5940963 ,  0.59719237,  0.60020431,  0.6031369 ,  0.60599455,
        0.60878126,  0.61150075,  0.61415641,  0.6167514 ,  0.61928864,
        0.62177084,  0.6242005 ,  0.62657999,  0.62891147,  0.631197  ,
        0.63343848,  0.63563771,  0.63779637,  0.63991605,  0.64199823,
        0.64404431,  0.64605561,  0.64803339,  0.64997884,  0.65189306,
        0.65377712,  0.65563203,  0.65745874,  0.65925816,  0.66103115,
        0.66277854,  0.6645011 ,  0.6661996 ,  0.66787473,  0.66952719,
        0.67115762,  0.67276665,  0.67435486,  0.67592285,  0.67747114,
        0.67900026,  0.68051073,  0.68200301,  0.68347759,  0.68493489,
        0.68637536,  0.6877994 ,  0.68920742,  0.69059979,  0.69197689,
        0.69333907,  0.69468667,  0.69602003,  0.69733946,  0.69864528,
        0.69993779,  0.70121726,  0.70248399,  0.70373824,  0.70498027,
        0.70621033,  0.70742868,  0.70863554,  0.70983115,  0.71101573,
        0.7121895 ,  0.71335267,  0.71450544,  0.715648  ,  0.71678055,
        0.71790329])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(3.0))
    cor_target = np.array(
      [ 0.        ,  0.15200493,  0.19124798,  0.21858541,  0.24021333,
        0.25837222,  0.27415936,  0.28820397,  0.30090441,  0.31253071,
        0.32327539,  0.33328108,  0.34265674,  0.35148774,  0.35984232,
        0.367776  ,  0.37533465,  0.38255664,  0.3894744 ,  0.39611569,
        0.40250439,  0.40866127,  0.4146045 ,  0.42035008,  0.42591217,
        0.4313034 ,  0.43653505,  0.44161725,  0.44655917,  0.45136909,
        0.45605456,  0.46062244,  0.46507902,  0.46943008,  0.47368092,
        0.47783644,  0.48190116,  0.48587928,  0.4897747 ,  0.49359102,
        0.49733164,  0.5009997 ,  0.50459816,  0.50812977,  0.51159714,
        0.5150027 ,  0.51834874,  0.52163742,  0.5248708 ,  0.52805078,
        0.5311792 ,  0.53425779,  0.53728817,  0.54027191,  0.54321047,
        0.54610526,  0.54895762,  0.55176881,  0.55454006,  0.55727251,
        0.55996727,  0.5626254 ,  0.56524791,  0.56783576,  0.57038989,
        0.57291117,  0.57540046,  0.57785857,  0.5802863 ,  0.58268439,
        0.58505357,  0.58739454,  0.58970796,  0.59199449,  0.59425474,
        0.59648932,  0.59869881,  0.60088376,  0.60304471,  0.60518219,
        0.6072967 ,  0.60938872,  0.61145873,  0.61350718,  0.61553452,
        0.61754116,  0.61952752,  0.62149401,  0.623441  ,  0.62536889,
        0.62727802,  0.62916877,  0.63104147,  0.63289645,  0.63473404,
        0.63655456,  0.6383583 ,  0.64014558,  0.64191668,  0.64367188,
        0.64541145])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(0.1))
    cor_target = np.array(
      [ 0.        ,  0.4019066 ,  0.44148923,  0.46635119,  0.48479565,
        0.49957763,  0.51197127,  0.5226759 ,  0.5321187 ,  0.54058065,
        0.54825684,  0.55528853,  0.56178139,  0.56781666,  0.57345817,
        0.57875705,  0.58375488,  0.588486  ,  0.59297907,  0.59725829,
        0.60134427,  0.60525472,  0.60900501,  0.61260849,  0.61607691,
        0.61942064,  0.62264885,  0.62576973,  0.62879062,  0.63171811,
        0.63455814,  0.6373161 ,  0.63999689,  0.64260496,  0.64514439,
        0.64761892,  0.65003198,  0.65238674,  0.65468611,  0.65693279,
        0.6591293 ,  0.66127796,  0.66338093,  0.66544024,  0.66745776,
        0.66943527,  0.6713744 ,  0.67327672,  0.67514369,  0.67697665,
        0.67877692,  0.6805457 ,  0.68228415,  0.68399334,  0.68567431,
        0.68732803,  0.68895541,  0.69055735,  0.69213466,  0.69368813,
        0.69521853,  0.69672657,  0.69821292,  0.69967825,  0.70112317,
        0.70254828,  0.70395415,  0.70534131,  0.7067103 ,  0.7080616 ,
        0.70939571,  0.71071306,  0.71201412,  0.71329929,  0.71456899,
        0.7158236 ,  0.7170635 ,  0.71828905,  0.7195006 ,  0.72069849,
        0.72188303,  0.72305454,  0.72421333,  0.72535967,  0.72649385,
        0.72761614,  0.7287268 ,  0.72982608,  0.73091423,  0.73199149,
        0.73305808,  0.73411423,  0.73516014,  0.73619604,  0.73722211,
        0.73823855,  0.73924556,  0.74024332,  0.741232  ,  0.74221179,
        0.74318283])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(0.2))
    cor_target = np.array(
      [ 0.        ,  0.44945291,  0.48885314,  0.51340023,  0.53151766,
        0.54598262,  0.55807405,  0.56849164,  0.5776617 ,  0.58586399,
        0.59329238,  0.60008701,  0.60635255,  0.61216937,  0.61760052,
        0.62269645,  0.62749817,  0.63203947,  0.63634856,  0.64044921,
        0.64436167,  0.64810333,  0.65168924,  0.6551325 ,  0.65844461,
        0.6616357 ,  0.66471476,  0.6676898 ,  0.67056796,  0.67335569,
        0.67605879,  0.67868251,  0.68123163,  0.68371048,  0.68612303,
        0.68847293,  0.69076352,  0.69299786,  0.69517881,  0.69730898,
        0.6993908 ,  0.70142654,  0.7034183 ,  0.70536804,  0.70727758,
        0.70914864,  0.71098282,  0.71278161,  0.71454642,  0.7162786 ,
        0.71797937,  0.71964992,  0.72129137,  0.72290475,  0.72449106,
        0.72605124,  0.72758619,  0.72909675,  0.73058372,  0.73204786,
        0.73348991,  0.73491055,  0.73631044,  0.73769021,  0.73905046,
        0.74039177,  0.74171468,  0.74301971,  0.74430737,  0.74557813,
        0.74683246,  0.7480708 ,  0.74929357,  0.75050118,  0.75169402,
        0.75287246,  0.75403687,  0.75518759,  0.75632496,  0.7574493 ,
        0.75856091,  0.75966011,  0.76074718,  0.76182239,  0.76288601,
        0.76393831,  0.76497954,  0.76600993,  0.76702973,  0.76803916,
        0.76903843,  0.77002777,  0.77100737,  0.77197744,  0.77293817,
        0.77388975,  0.77483235,  0.77576616,  0.77669135,  0.77760808,
        0.7785165 ])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(0.5))
    cor_target = np.array(
      [ 0.        ,  0.44945291,  0.48885314,  0.51340023,  0.53151766,
        0.54598262,  0.55807405,  0.56849164,  0.5776617 ,  0.58586399,
        0.59329238,  0.60008701,  0.60635255,  0.61216937,  0.61760052,
        0.62269645,  0.62749817,  0.63203947,  0.63634856,  0.64044921,
        0.64436167,  0.64810333,  0.65168924,  0.6551325 ,  0.65844461,
        0.6616357 ,  0.66471476,  0.6676898 ,  0.67056796,  0.67335569,
        0.67605879,  0.67868251,  0.68123163,  0.68371048,  0.68612303,
        0.68847293,  0.69076352,  0.69299786,  0.69517881,  0.69730898,
        0.6993908 ,  0.70142654,  0.7034183 ,  0.70536804,  0.70727758,
        0.70914864,  0.71098282,  0.71278161,  0.71454642,  0.7162786 ,
        0.71797937,  0.71964992,  0.72129137,  0.72290475,  0.72449106,
        0.72605124,  0.72758619,  0.72909675,  0.73058372,  0.73204786,
        0.73348991,  0.73491055,  0.73631044,  0.73769021,  0.73905046,
        0.74039177,  0.74171468,  0.74301971,  0.74430737,  0.74557813,
        0.74683246,  0.7480708 ,  0.74929357,  0.75050118,  0.75169402,
        0.75287246,  0.75403687,  0.75518759,  0.75632496,  0.7574493 ,
        0.75856091,  0.75966011,  0.76074718,  0.76182239,  0.76288601,
        0.76393831,  0.76497954,  0.76600993,  0.76702973,  0.76803916,
        0.76903843,  0.77002777,  0.77100737,  0.77197744,  0.77293817,
        0.77388975,  0.77483235,  0.77576616,  0.77669135,  0.77760808,
        0.7785165 ])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(2.0))
    cor_target = np.array(
      [ 0.        ,  0.26347348,  0.30426801,  0.3309032 ,  0.35114805,
        0.36766262,  0.38170302,  0.39396967,  0.40489599,  0.41477014,
        0.42379413,  0.43211541,  0.43984514,  0.44706931,  0.45385595,
        0.46025983,  0.46632574,  0.47209084,  0.47758629,  0.48283851,
        0.4878701 ,  0.49270056,  0.49734684,  0.50182377,  0.5061444 ,
        0.51032028,  0.5143617 ,  0.51827783,  0.52207694,  0.52576645,
        0.52935309,  0.53284297,  0.53624166,  0.53955422,  0.54278532,
        0.54593924,  0.5490199 ,  0.55203095,  0.55497573,  0.55785739,
        0.56067879,  0.56344265,  0.56615146,  0.56880758,  0.5714132 ,
        0.57397038,  0.57648104,  0.578947  ,  0.58136995,  0.58375152,
        0.5860932 ,  0.58839644,  0.59066258,  0.59289291,  0.59508863,
        0.59725091,  0.59938082,  0.60147942,  0.60354768,  0.60558654,
        0.60759691,  0.60957963,  0.61153552,  0.61346536,  0.61536989,
        0.61724982,  0.61910584,  0.6209386 ,  0.62274871,  0.62453679,
        0.6263034 ,  0.6280491 ,  0.62977441,  0.63147986,  0.63316592,
        0.63483307,  0.63648177,  0.63811245,  0.63972554,  0.64132143,
        0.64290053,  0.64446321,  0.64600984,  0.64754077,  0.64905634,
        0.65055688,  0.65204271,  0.65351415,  0.65497148,  0.65641499,
        0.65784498,  0.6592617 ,  0.66066543,  0.66205641,  0.6634349 ,
        0.66480113,  0.66615534,  0.66749775,  0.66882859,  0.67014807,
        0.67145639])
    np.testing.assert_allclose(cor, cor_target)

    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, SA(5.0))
    cor_target = np.array(
      [ 0.        ,  0.12402312,  0.15999168,  0.18557647,  0.20609443,
        0.22349771,  0.23875233,  0.25241667,  0.26484659,  0.27628465,
        0.28690463,  0.29683585,  0.3061775 ,  0.31500756,  0.32338858,
        0.33137161,  0.33899893,  0.34630602,  0.35332297,  0.36007552,
        0.36658596,  0.37287365,  0.37895559,  0.38484677,  0.3905605 ,
        0.39610864,  0.40150184,  0.40674965,  0.41186075,  0.41684298,
        0.42170349,  0.42644882,  0.43108494,  0.43561736,  0.44005113,
        0.44439094,  0.44864112,  0.45280568,  0.45688836,  0.46089264,
        0.46482176,  0.46867876,  0.47246648,  0.4761876 ,  0.47984461,
        0.48343988,  0.48697562,  0.49045392,  0.49387678,  0.49724606,
        0.50056352,  0.50383086,  0.50704967,  0.51022145,  0.51334766,
        0.51642965,  0.51946874,  0.52246616,  0.52542312,  0.52834073,
        0.53122009,  0.53406223,  0.53686815,  0.53963879,  0.54237507,
        0.54507786,  0.547748  ,  0.5503863 ,  0.55299353,  0.55557043,
        0.55811773,  0.56063611,  0.56312625,  0.56558877,  0.56802429,
        0.57043342,  0.57281673,  0.57517477,  0.57750808,  0.57981718,
        0.58210257,  0.58436474,  0.58660415,  0.58882126,  0.59101651,
        0.59319033,  0.59534313,  0.59747531,  0.59958726,  0.60167935,
        0.60375196,  0.60580544,  0.60784014,  0.60985639,  0.61185451,
        0.61383483,  0.61579765,  0.61774327,  0.61967199,  0.62158409,
        0.62347984])
    np.testing.assert_allclose(cor, cor_target)

    # Undefined:
    cor = ga10.GodaAtkinson2010.getSpatialCorrelation(d, 'PGD')
    cor_target = np.array(
      [ 0.        ,  0.3575817 ,  0.39874653,  0.42491472,  0.44447585,
        0.4602403 ,  0.47351603,  0.48502441,  0.4952078 ,  0.50435814,
        0.51267872,  0.52031708,  0.52738388,  0.53396433,  0.54012554,
        0.54592134,  0.55139559,  0.55658456,  0.56151855,  0.56622319,
        0.57072035,  0.57502884,  0.57916497,  0.58314296,  0.58697532,
        0.5906731 ,  0.59424609,  0.59770305,  0.6010518 ,  0.60429941,
        0.60745223,  0.61051605,  0.6134961 ,  0.61639717,  0.61922365,
        0.62197954,  0.62466854,  0.62729404,  0.62985921,  0.63236693,
        0.63481993,  0.63722069,  0.63957157,  0.64187473,  0.64413223,
        0.64634596,  0.6485177 ,  0.65064914,  0.65274185,  0.65479732,
        0.65681693,  0.65880202,  0.66075382,  0.66267351,  0.66456221,
        0.66642097,  0.66825079,  0.67005263,  0.67182739,  0.67357593,
        0.67529906,  0.67699757,  0.6786722 ,  0.68032367,  0.68195264,
        0.68355976,  0.68514567,  0.68671094,  0.68825614,  0.68978183,
        0.69128852,  0.69277671,  0.69424688,  0.6956995 ,  0.697135  ,
        0.69855383,  0.69995637,  0.70134304,  0.70271421,  0.70407025,
        0.70541151,  0.70673833,  0.70805105,  0.70934997,  0.71063541,
        0.71190767,  0.71316703,  0.71441376,  0.71564814,  0.71687042,
        0.71808086,  0.7192797 ,  0.72046717,  0.72164351,  0.72280893,
        0.72396365,  0.72510787,  0.72624181,  0.72736565,  0.72847959,
        0.72958381])
    np.testing.assert_allclose(cor, cor_target)

if __name__ == '__main__':
    test_goda_atkinson_2010()
